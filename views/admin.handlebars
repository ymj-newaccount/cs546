{{!-- views/admin.handlebars --}}
{{!--
  Admin Dashboard (server-rendered with Handlebars)

  Expected locals from routes/admin.js:
    - synced: boolean (query param)
    - flash: { type: "success"|"error", message: string } | null
    - reports: array
    - hasReports: boolean
    - csrfToken: string (admin-scoped CSRF token)
--}}

<h1>Admin Dashboard</h1>

{{!-- One-time banner message (set via session flash in routes/admin.js) --}}
{{#if flash}}
  <div
    role="status"
    aria-live="polite"
    style="margin: 1rem 0; padding: 0.75rem 1rem; border: 1px solid #999;"
  >
    <strong>{{flash.type}}:</strong> {{flash.message}}
  </div>
{{/if}}

{{#if synced}}
  <p><strong>Data sync completed.</strong></p>
{{/if}}

<p>This is the admin dashboard for CommuteAble NYC.</p>
<p>
  The button below triggers a full snapshot import (seedAll) from the
  external open-data sources into MongoDB.
</p>

<form method="post" action="/admin/sync" style="margin-bottom: 1.5rem;">
  {{!-- Admin CSRF token (cookie + hidden field) --}}
  <input type="hidden" name="csrfToken" value="{{csrfToken}}">
  <button type="submit">Sync Data (run seedAll)</button>
</form>

<hr />

{{!-- Merge duplicates section --}}
<h2 id="merge-duplicates">Merge Duplicate Reports</h2>

<p>
  Use this tool to merge one duplicate report into a canonical report.
  Votes on the duplicate will be migrated to the kept report (per-user conflicts resolved by most recent vote),
  and the duplicate report will be hidden.
</p>

<form
  method="post"
  action="/admin/reports/merge"
  style="margin: 1rem 0 1.5rem 0;"
  onsubmit="return confirm('Merge duplicate report into the kept report? This will hide the duplicate.');"
>
  {{!-- Admin CSRF token (cookie + hidden field) --}}
  <input type="hidden" name="csrfToken" value="{{csrfToken}}">

  {{!--
    Use a datalist to reduce typos.
    (The admin route also accepts keepId/dupId aliases, but we standardize on keepReportId/dupReportId here.)
  --}}
  <datalist id="reportIdList">
    {{#if hasReports}}
      {{#each reports}}
        <option value="{{this.reportId}}"></option>
      {{/each}}
    {{/if}}
  </datalist>

  <div style="margin-bottom: 0.75rem;">
    <label for="keepReportId" style="display: inline-block; width: 180px;">
      Keep reportId:
    </label>
    <input
      id="keepReportId"
      name="keepReportId"
      list="reportIdList"
      required
      autocomplete="off"
      style="min-width: 320px;"
    >
  </div>

  <div style="margin-bottom: 0.75rem;">
    <label for="dupReportId" style="display: inline-block; width: 180px;">
      Duplicate reportId:
    </label>
    <input
      id="dupReportId"
      name="dupReportId"
      list="reportIdList"
      required
      autocomplete="off"
      style="min-width: 320px;"
    >
  </div>

  <button type="submit">Merge</button>
</form>

<hr />

<h2>Recent Reports</h2>

{{#if hasReports}}
  <table border="1" cellpadding="4" cellspacing="0">
    <thead>
      <tr>
        <th>Report ID</th>
        <th>Target</th>
        <th>Text</th>
        <th>Status</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {{#each reports}}
        <tr>
          <td>{{this.reportId}}</td>
          <td>{{this.targetType}}: {{this.targetId}}</td>
          <td>{{this.text}}</td>
          <td>{{this.status}}</td>
          <td>{{this.createdAt}}</td>
          <td>
            {{!-- Hide / Unhide toggle --}}
            {{#if this.isHidden}}
              <form method="post" action="/admin/reports/{{this.reportId}}/unhide" style="display:inline;">
                <input type="hidden" name="csrfToken" value="{{../csrfToken}}">
                <button type="submit">Unhide</button>
              </form>
            {{else}}
              <form method="post" action="/admin/reports/{{this.reportId}}/hide" style="display:inline;">
                <input type="hidden" name="csrfToken" value="{{../csrfToken}}">
                <button type="submit">Hide</button>
              </form>
            {{/if}}

            {{!-- Delete (permanent) --}}
            <form
              method="post"
              action="/admin/reports/{{this.reportId}}/delete"
              style="display:inline;"
              onsubmit="return confirm('Delete this report permanently?');"
            >
              <input type="hidden" name="csrfToken" value="{{../csrfToken}}">
              <button type="submit">Delete</button>
            </form>

            {{!--
              Convenience buttons:
              Fill the merge form inputs from a row (no server-side changes needed).
              We store the reportId in data attributes to avoid string escaping issues.
            --}}
            <button
              type="button"
              data-merge-fill="keep"
              data-report-id="{{this.reportId}}"
              style="margin-left: 0.5rem;"
            >
              Use as Keep
            </button>

            <button
              type="button"
              data-merge-fill="dup"
              data-report-id="{{this.reportId}}"
            >
              Use as Duplicate
            </button>
          </td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  {{!-- Small client-side helper: fill merge inputs from table buttons --}}
  <script>
    // Fill the "Merge Duplicate Reports" form using the per-row convenience buttons.
    (function () {
      const keepInput = document.getElementById('keepReportId');
      const dupInput = document.getElementById('dupReportId');
      const section = document.getElementById('merge-duplicates');

      if (!keepInput || !dupInput) return;

      const buttons = document.querySelectorAll('button[data-merge-fill][data-report-id]');
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const which = btn.getAttribute('data-merge-fill');
          const id = btn.getAttribute('data-report-id');

          if (which === 'keep') keepInput.value = id;
          if (which === 'dup') dupInput.value = id;

          // Bring the merge form into view so the admin can immediately submit.
          if (section && section.scrollIntoView) {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
    })();
  </script>
{{else}}
  <p>No reports found in the database yet.</p>
{{/if}}
